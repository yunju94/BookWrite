<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <title>Title</title>

    <!--그래프 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>


    <!-- Bootstrap CSS 포함 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- Bootstrap JavaScript 포함 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

</head>
<th:block layout:fragment="script">
    <script th:inline="javascript">

        $(document).ready(function () {

           var List = [[${coinList}]]; // Thymeleaf 템플릿에서 pointList를 배열로 변환하여 전달합니다.
            var KDRcoin = 0.0;
            var YEScoin = 0.0;

            // 배열을 반복하여 KDR_coin과 YES_coin의 합계를 계산합니다.
            for (let i = 0; i < List.length; i++) {
                KDRcoin += List[i].kdr_coin; // 객체의 속성에 접근합니다.

                YEScoin += List[i].yes_coin; // 객체의 속성에 접근합니다.

            }

            // jQuery를 사용하여 HTML 요소의 텍스트를 업데이트합니다.
            $('#KDRCoin').text(KDRcoin);
            $('#YESCoin').text(YEScoin);

              $('#current').change(function() {
                  // 선택된 값 가져오기
                  var selectValue = $(this).val();

                  // 모든 카드 숨기기
                  $('.card').hide();
                  $('#myChartKDR').hide();
                   $('#myChartYES').hide();

                  // 선택된 값에 따라 카드 표시
                  if (selectValue === "KDR") {
                      $('#KDR').show();
                      $('#myChartKDR').show();
                      KDR();
                  } else if (selectValue === "YES") {
                      $('#YES').show();
                      $('#myChartYES').show();
                      YES();
                  }
              });

              // 페이지 로드 시 현재 선택된 값에 따라 카드 표시
              $('#current').trigger('change');



                $('#KDR_coin').change(function(){
            //코인을 선택하면 현재 가격에 대한 합계 포인트 사용 비용이 나온다.
            var KDR_stck=$('#KDR_stck_prpr').text();
            var count = $(this).val();


            var total =  (KDR_stck) * (count);
            $('#KDR_total').text(total);

            var client = [[${total}]]
               var clientNumber = parseInt(client.replace(/\D/g, ''), 10);
             if(clientNumber<total){
                 $('#KDR_coinBtn').hide();
                 $('#KDR_pointBtn').show();
             }else{
                $('#KDR_coinBtn').show();
                $('#KDR_pointBtn').hide();
             }



        })


                $('#YES_coin').change(function(){
            //코인을 선택하면 현재 가격에 대한 합계 포인트 사용 비용이 나온다.
            var YES_stck=$('#YES_stck_prpr').text();
            var count = $(this).val();


            var total =  (YES_stck) * (count);
            $('#YES_total').text(total);

               var client = [[${total}]]
               var clientNumber = parseInt(client.replace(/\D/g, ''), 10);

             if(clientNumber<total){
                 $('#YES_coinBtn').hide();
                 $('#YES_pointBtn').show();
             }else{
                $('#YES_coinBtn').show();
                $('#YES_pointBtn').hide();
             }


        })



        });


          //만약에 키다리 스튜디오를 선택할 경우, 해당 주식 금액이 나온다.
        function KDR() {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            url = "/equities/020120";

            $.ajax({
                url: url,
                type: "POST",
                contentType: "application/json",
                beforeSend: function (xhr) {
                    // 데이터 전송하기 전에 헤더에 csrf 값을 설정
                    xhr.setRequestHeader(header, token);
                },
                dataType: "json",
                cache: false,
                success: function (result, status) {
                    var equity = result.equity;

                    var stck_prpr = equity.stck_prpr;

                        var prdy_vrss = equity.prdy_vrss;
                        var prdy_vrss_sign = equity.prdy_vrss_sign;

                           var color;
                            if (prdy_vrss_sign < 3) {
                                color = 'red';
                            } else if (prdy_vrss_sign > 3) {
                                color = 'blue';
                            } else {
                                color = 'black';}

                    $('#KDR_stck_prpr').text(stck_prpr);
                    $('#KDR_prdy_vrss').text(prdy_vrss).css('color', color);

                    $('#KDR_total').text(stck_prpr);

                    var client = [[${total}]]
                    var clientNumber = parseInt(client.replace(/\D/g, ''), 10);

                        if(clientNumber<stck_prpr){
                         $('#KDR_coinBtn').hide();
                         $('#KDR_pointBtn').show();
                          console.log("2222222")
                     }else{
                        $('#KDR_coinBtn').show();
                        $('#KDR_pointBtn').hide();
                     }


                },
                error: function (jqXHR, status, error) {
                    if (jqXHR.status == '401') {
                        alert('로그인 후 이용해주세요');
                        location.href = '/members/login';
                    } else {
                        alert(jqXHR.responseText);
                    }
                }
            });
        }




         function YES() {//예스 24를 선택할 경우 해당 주식의 가격이 나온다.
                var token = $("meta[name='_csrf']").attr("content");
                var header = $("meta[name='_csrf_header']").attr("content");

                url = "/equities/053280";

                $.ajax({
                    url: url,
                    type: "POST",
                    contentType: "application/json",
                    beforeSend: function (xhr) {
                        // 데이터 전송하기 전에 헤더에 csrf 값을 설정
                        xhr.setRequestHeader(header, token);
                    },
                    dataType: "json",
                    cache: false,
                    success: function (result, status) {
                        var equity = result.equity;

                        var stck_prpr = equity.stck_prpr;
                        var prdy_vrss = equity.prdy_vrss;
                        var prdy_vrss_sign = equity.prdy_vrss_sign;

                              var color;
                            if (prdy_vrss_sign < 3) {
                                color = 'red';
                            } else if (prdy_vrss_sign > 3) {
                                color = 'blue';
                            } else {
                                color = 'black';}

                        $('#YES_stck_prpr').text(stck_prpr);
                        $('#YES_prdy_vrss').text(prdy_vrss).css('color', color);

                        $('#YES_total').text(stck_prpr)


                        var client = [[${total}]]
                    var clientNumber = parseInt(client.replace(/\D/g, ''), 10);

                        if(clientNumber<stck_prpr){
                         $('#YES_coinBtn').hide();
                         $('#YES_pointBtn').show();
                     }else{
                        $('#YES_coinBtn').show();
                        $('#YES_pointBtn').hide();
                     }


                    },
                    error: function (jqXHR, status, error) {
                        if (jqXHR.status == '401') {
                            alert('로그인 후 이용해주세요');
                            location.href = '/members/login';
                        } else {
                            alert(jqXHR.responseText);
                        }
                    }
                });
            }

        function point(){
            location.href="/charge"
        }

        function KDR_coin(){
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");


            var coinMoney = $('#KDR_total').text();
            var client = [[${total}]]
            var clientNumber = parseInt(client.replace(/\D/g, ''), 10);
            var coin=$('#KDR_coin').val()

            url="/coin/add/KDR/"+ coin + "/" + coinMoney
            var paramData = {
                coinMoney: coinMoney,
                coin: coin,
            };

             var param = JSON.stringify(paramData);
               $.ajax({
                url: url,
                type: "POST",
                contentType: "application/json",
                data: param,
                beforeSend: function (xhr) {
                    // 데이터 전송하기 전에 헤더에 csrf 값을 설정
                    xhr.setRequestHeader(header, token);
                },
                dataType: "json",
                cache: false,
                success: function (result, status) {
                    alert("코인 구매 완료!");
                    location.href="/coinList"
                },
                error: function (jqXHR, status, error) {
                    if (jqXHR.status == '401') {
                        alert('로그인 후 이용해주세요.');
                        location.href = '/members/login';
                    } else {
                        alert(jqXHR.responseText);
                    }
                }
            });
        }


        function YES_coin(){
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");


            var coinMoney = $('#YES_total').text();
            var client = [[${total}]]
            var clientNumber = parseInt(client.replace(/\D/g, ''), 10);
            var coin=$('#KDR_coin').val()

            url="/coin/add/YES/"+ coin + "/" + coinMoney
            var paramData = {
                coinMoney: coinMoney,
                coin: coin,
            };

             var param = JSON.stringify(paramData);
               $.ajax({
                url: url,
                type: "POST",
                contentType: "application/json",
                data: param,
                beforeSend: function (xhr) {
                    // 데이터 전송하기 전에 헤더에 csrf 값을 설정
                    xhr.setRequestHeader(header, token);
                },
                dataType: "json",
                cache: false,
                success: function (result, status) {
                    alert("코인 구매 완료!");
                    location.href="/coinList"
                },
                error: function (jqXHR, status, error) {
                    if (jqXHR.status == '401') {
                        alert('로그인 후 이용해주세요.');
                        location.href = '/members/login';
                    } else {
                        alert(jqXHR.responseText);
                    }
                }
            });
        }








          function sliding() {
        var context = document.getElementById('slide_context');
        // 'show' 클래스를 토글하여 슬라이드 효과 적용
        if (context.classList.contains('show')) {
            context.classList.remove('show');
        } else {
            context.classList.add('show');
        }
    }



    </script>
</th:block>

    <th:block layout:fragment="css">
    <style>
                /* 부모 컨테이너 */
         .container {
             max-width: 600px; /* 최대 너비 설정 */
             min-width: 300px; /* 최소 너비 설정 */
             margin: 0 auto; /* 중앙 정렬 */
             padding: 0 15px; /* 좌우 여백 설정 */
         }

         /* card */
         .card,  .gragh{
             width: 100%;
             max-width: 600px; /* 최대 너비 설정 */
             min-width: 300px; /* 최소 너비 설정 */
             margin: 20px auto;
             text-align: center;
         }

           .sel_1, .sel_2 {
             margin: 10px;
         }


         .sel_2, .sel_3 {
             text-align: right;

         }

         .fs-2 {
             font-size: 0.8em; /* 폰트 사이즈 조정 */
         }

         .btnBtn {
             margin-top: 10px;
         }

         /* 미디어 쿼리로 모바일에서의 스타일 조정 */
         @media (max-width: 576px) {
             .sel_1, .sel_2 {

                  text-align: center;
             }

             .fs-2 {
                 font-size: 0.9em;
             }

             .btnBtn {
                 margin-left: 0;
             }
         }


         /* 슬라이드 컨테이너 */
         #slide_context {
             width: 100%; /* 폭을 부모에 맞춤 */
             max-width: 600px; /* 최대 너비 설정 */
             min-width: 300px; /* 최소 너비 설정 */
             overflow: hidden; /* 내용이 넘치는 것을 숨김 */
             max-height: 0; /* 초기 최대 높이 설정 */
             opacity: 0; /* 초기 투명도 설정 */
             transition: max-height 0.5s ease-out, opacity 0.5s ease-out; /* 애니메이션 트랜지션 설정 */
             background-color: white; /* 배경 색상 설정 (선택 사항) */
             padding: 0; /* 여백 초기 설정 */
             border: 1px solid #dee2e6; /* 테두리 설정 (선택 사항) */
             border-radius: 4px; /* 테두리 둥글게 설정 (선택 사항) */
             margin: 20px auto; /* 카드와 동일한 여백 설정 */
         }

         /* show 클래스 */
         #slide_context.show {
             max-height: 500px; /* 슬라이드가 열릴 때의 최대 높이 설정 */
             opacity: 1; /* 보일 때 투명도 설정 */
             padding: 10px; /* 여백 설정 (선택 사항) */
         }
    </style>
    </th:block>



<div layout:fragment="content">

    <div class="sel_1">
        <select id="current">
            <option th:value="KDR">키다리스튜디오(020120)</option>
            <option th:value="YES">예스24(053280)</option>
        </select>
    </div>


    <div class="sel_2">

        현재 포인트: <span th:text="${total}"></span>point


    </div>
    <div class="sel_3">
        키다리 코인:
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-currency-euro" viewBox="0 0 16 16">
            <path d="M4 9.42h1.063C5.4 12.323 7.317 14 10.34 14c.622 0 1.167-.068 1.659-.185v-1.3c-.484.119-1.045.17-1.659.17-2.1 0-3.455-1.198-3.775-3.264h4.017v-.928H6.497v-.936q-.002-.165.008-.329h4.078v-.927H6.618c.388-1.898 1.719-2.985 3.723-2.985.614 0 1.175.05 1.659.177V2.194A6.6 6.6 0 0 0 10.341 2c-2.928 0-4.82 1.569-5.244 4.3H4v.928h1.01v1.265H4v.928z"/>
        </svg>
        <span id="KDRCoin"></span>
        예스 코인:
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-currency-yen" viewBox="0 0 16 16">
            <path d="M8.75 14v-2.629h2.446v-.967H8.75v-1.31h2.445v-.967H9.128L12.5 2h-1.699L8.047 7.327h-.086L5.207 2H3.5l3.363 6.127H4.778v.968H7.25v1.31H4.78v.966h2.47V14h1.502z"/>
        </svg>
        <span id="YESCoin"></span>
    </div>

    <div class="container">
    <div class="h4 pb-2 mb-4 text-danger border-bottom border-info"></div>
        <div class="card" id="KDR">
            <div class="card-header">
                <h2>키다리스튜디오(020120)</h2>
            </div>
            <div class="card-body">
                <div>
                    <span class="fs-1" id="KDR_stck_prpr"></span>원<!--주식의 현재 가격을 나타내는 변수나 속성 이름-->
                    <span class="fs-2" id="KDR_prdy_vrss"></span>
                              <!-- 주식 변동 가격을 여기에 표시 -->
                <div>
                    <span>변경 코인 수량</span>
                    <select id="KDR_coin">
                        <option value="1">1코인</option>
                        <option value="10">10코인</option>
                        <option value="25">25코인</option>
                        <option value="50">50코인</option>
                        <option value="100">100코인</option>
                    </select>

                </div>
                <div>
                    총<span id="KDR_total"></span>포인트
                </div>

            </div>
                <div class="btnBtn">
                    <button type="button" id="KDR_coinBtn"  class="btn btn-outline-secondary"
                            onclick="KDR_coin()">코인 결제</button>
                    <button type="button" id="KDR_pointBtn"  class="btn btn-outline-secondary"
                            onclick='point()'>포인트 결제</button>

                </div>

        </div>
    </div>
    <div class="gragh">
        <canvas id="myChartKDR" style="width:100%;max-width:700px"></canvas>
        <script>
            // 그래프 설정
          var now = new Date();

          // 7일 전 날짜 계산
          var minusWeek = new Date(now);
          minusWeek.setDate(now.getDate() -6);
          //6일 전(일주일)으로 변경
          // 날짜 배열 초기화
          var xValues = [];
          // 7일 간의 날짜 배열 생성
          for (var date = new Date(minusWeek); date <= now; date.setDate(date.getDate() + 1)) {
              var formattedDate = date.toISOString().slice(0,10); // "YYYY-MM-DD" 형식
              xValues.push(formattedDate); //배열에 추가
          }


          // 서버에서 데이터를 받아오는 반복문
            var yValues1_1=  [ [[${KDR}]] ];
            var yValues1=yValues1_1.pop(0);

          new Chart(document.getElementById("myChartKDR"), {
              type: "line",
              data: {
                  labels: xValues,
                  datasets: [{
                      data: yValues1,
                      borderColor: "red",
                      fill: false
                  }]
              },
              options: {
                  legend: { display: false }
              }
          });

        </script>
    </div>

        <div class="card" id="YES">
            <div class="card-header">
                <h2>예스24(053280)</h2>
            </div>
            <div class="card-body">
                <div>
                    <span class="fs-1" id="YES_stck_prpr"></span>원<!--주식의 현재 가격을 나타내는 변수나 속성 이름-->
                    <span class="fs-2" id="YES_prdy_vrss" ></span>
                </div>
                <div>
                    <span>변경 코인 수량</span>
                    <select id="YES_coin">
                        <option value="1">1코인</option>
                        <option value="10">10코인</option>
                        <option value="25">25코인</option>
                        <option value="50">50코인</option>
                        <option value="100">100코인</option>
                    </select>

                </div>
                <div>
                    총<span id="YES_total"></span>포인트
                </div>
                <div class="btnBtn">
                    <button type="button" id="YES_coinBtn"  class="btn btn-outline-secondary"
                            onclick="coin()">코인 결제</button>
                    <button type="button" id="YES_pointBtn"  class="btn btn-outline-secondary"
                            onclick='point()'>포인트 결제</button>

                </div>
            </div>

        </div>
    <div class="gragh">
        <div>
            <canvas id="myChartYES" style="width:100%;max-width:700px"></canvas>
            <script>
                // 그래프 설정
              var now = new Date();

              // 7일 전 날짜 계산
              var minusWeek = new Date(now);
              minusWeek.setDate(now.getDate() -6);
              //6일 전(일주일)으로 변경
              // 날짜 배열 초기화
              var xValues = [];
              // 7일 간의 날짜 배열 생성
              for (var date = new Date(minusWeek); date <= now; date.setDate(date.getDate() + 1)) {
                  var formattedDate = date.toISOString().slice(0,10); // "YYYY-MM-DD" 형식
                  xValues.push(formattedDate); //배열에 추가
              }


              // 서버에서 데이터를 받아오는 반복문
                var yValues1_1=  [ [[${YES}]] ];
                var yValues1=yValues1_1.pop(0);

              new Chart(document.getElementById("myChartYES"), {
                  type: "line",
                  data: {
                      labels: xValues,
                      datasets: [{
                          data: yValues1,
                          borderColor: "red",
                          fill: false
                      }]
                  },
                  options: {
                      legend: { display: false }
                  }
              });

            </script>
        </div>

        <div onclick="sliding()">
            <span>결제 내역</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
            </svg>
        </div>
        <div id="slide_context" >
            <table>
                <thead>
                <tr>
                    <th style="width:180px;">내용</th>
                    <th style="width:180px;">포인트</th>
                    <th style="width:100px;">키다리 코인</th>
                    <th style="width:100px;">예스 코인</th>

                </tr>
                </thead>
                <tbody th:each="ch : ${coinList}">
                <tr>
                    <td th:text="${ch.point.content}" ></td>
                    <td th:text="${ch.point.point}" ></td>
                    <td th:text="${ch.KDR_coin}"></td>
                    <td th:text="${ch.YES_coin}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>


    </div>






</div>
</html>