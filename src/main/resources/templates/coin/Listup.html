<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>조은북</title>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!--그래프 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>


    <!-- Bootstrap CSS 포함 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- Bootstrap JavaScript 포함 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

</head>
<th:block layout:fragment="script">
    <script th:inline="javascript">

        $(document).ready(function () {

        kdr_coin = [[${kdr_coin}]]; // double 타입으로 값 전달
       // console.log("KDR Coin Value: " + kdr_coin);
        yes_coin = [[${yes_coin}]]; // double 타입으로 값 전달
       // console.log("YES Coin Value: " + yes_coin);



      // 계산된 값을 HTML 요소에 업데이트
      $('#KDRCoin').text(kdr_coin);
      $('#YESCoin').text(yes_coin);

      // 선택박스 값이 변경될 때 호출되는 함수
      $('#current').change(function () {
          var selectValue = $(this).val(); // 선택된 값 가져오기

          // 모든 카드와 차트 숨기기
          $('.card').hide();
          $('#myChartKDR').hide();
          $('#myChartYES').hide();

          // 선택된 값에 따라 카드와 차트 표시
          if (selectValue === "KDR") {
              $('#KDR').show();
              $('#myChartKDR').show();
              KDR(); // KDR 관련 데이터 로드
          } else if (selectValue === "YES") {
              $('#YES').show();
              $('#myChartYES').show();
              YES(); // YES 관련 데이터 로드
          }
      });

      // 페이지 로드 시 현재 선택된 값에 따라 카드와 차트 표시
      $('#current').trigger('change');

      // KDR_coin 선택 시 호출되는 함수
      $('#KDR_coin').change(function () {
          var KDR_stck = parseFloat($('#KDR_stck_prpr').text()); // 현재 KDR 주식 가격
          var count = parseFloat($(this).val()); // 선택된 개수

          var total = KDR_stck * count; // 총 가격 계산
          $('#KDR_total').text(total.toFixed(2)); // 총 가격 표시

          // 클라이언트의 현재 총액과 비교
          var client = parseFloat($('#client_total').text().replace(/[^0-9.]/g, ''));
          if (client < total) {
              $('#KDR_coinBtn').hide(); // 부족할 경우 버튼 숨기기
              $('#KDR_pointBtn').show(); // 포인트 버튼 표시
          } else {
              $('#KDR_coinBtn').show(); // 충분할 경우 코인 버튼 표시
              $('#KDR_pointBtn').hide(); // 포인트 버튼 숨기기
          }
      });

      // YES_coin 선택 시 호출되는 함수
      $('#YES_coin').change(function () {
          var YES_stck = parseFloat($('#YES_stck_prpr').text()); // 현재 YES 주식 가격
          var count = parseFloat($(this).val()); // 선택된 개수

          var total = YES_stck * count; // 총 가격 계산
          $('#YES_total').text(total.toFixed(2)); // 총 가격 표시

          // 클라이언트의 현재 총액과 비교
          var client = parseFloat($('#client_total').text().replace(/[^0-9.]/g, ''));
          if (client < total) {
              $('#YES_coinBtn').hide(); // 부족할 경우 버튼 숨기기
              $('#YES_pointBtn').show(); // 포인트 버튼 표시
          } else {
              $('#YES_coinBtn').show(); // 충분할 경우 코인 버튼 표시
              $('#YES_pointBtn').hide(); // 포인트 버튼 숨기기
          }
      });
  });

  function KDR() {
      var token = $("meta[name='_csrf']").attr("content"); // CSRF 토큰 가져오기
      var header = $("meta[name='_csrf_header']").attr("content"); // CSRF 헤더 가져오기

      var url = "/equities/020120"; // KDR 주식 정보 요청 URL

      $.ajax({
          url: url,
          type: "POST",
          contentType: "application/json",
          beforeSend: function (xhr) {
              xhr.setRequestHeader(header, token); // CSRF 값 설정
          },
          dataType: "json",
          cache: false,
          success: function (result) {
              var equity = result.equity;

              var stck_prpr = equity.stck_prpr; // 주식 가격
              var prdy_vrss = equity.prdy_vrss; // 전일 대비 변동
              var prdy_vrss_sign = equity.prdy_vrss_sign; // 전일 대비 변동 기호

              // 전일 대비 변동 기호에 따른 색상 설정
              var color = (prdy_vrss_sign < 3) ? 'red' : (prdy_vrss_sign > 3) ? 'blue' : 'black';

              $('#KDR_stck_prpr').text(stck_prpr); // 주식 가격 표시
              $('#KDR_prdy_vrss').text(prdy_vrss).css('color', color); // 변동 표시

              $('#KDR_total').text(stck_prpr); // 총 가격 업데이트

              var client = parseFloat($('#client_total').text().replace(/[^0-9.]/g, '')); // 클라이언트 총액
              if (client < stck_prpr) {
                  $('#KDR_coinBtn').hide(); // 부족할 경우 버튼 숨기기
                  $('#KDR_pointBtn').show(); // 포인트 버튼 표시
              } else {
                  $('#KDR_coinBtn').show(); // 충분할 경우 코인 버튼 표시
                  $('#KDR_pointBtn').hide(); // 포인트 버튼 숨기기
              }
          },
          error: function (jqXHR) {
              if (jqXHR.status == '401') {
                  alert('로그인 후 이용해주세요'); // 로그인 요구 알림
                  location.href = '/members/login'; // 로그인 페이지로 이동
              } else {
                  alert(jqXHR.responseText); // 기타 오류 알림
              }
          }
      });
  }

  function YES() {
      var token = $("meta[name='_csrf']").attr("content"); // CSRF 토큰 가져오기
      var header = $("meta[name='_csrf_header']").attr("content"); // CSRF 헤더 가져오기

      var url = "/equities/053280"; // YES 주식 정보 요청 URL

      $.ajax({
          url: url,
          type: "POST",
          contentType: "application/json",
          beforeSend: function (xhr) {
              xhr.setRequestHeader(header, token); // CSRF 값 설정
          },
          dataType: "json",
          cache: false,
          success: function (result) {
              var equity = result.equity;

              var stck_prpr = equity.stck_prpr; // 주식 가격
              var prdy_vrss = equity.prdy_vrss; // 전일 대비 변동
              var prdy_vrss_sign = equity.prdy_vrss_sign; // 전일 대비 변동 기호

              // 전일 대비 변동 기호에 따른 색상 설정
              var color = (prdy_vrss_sign < 3) ? 'red' : (prdy_vrss_sign > 3) ? 'blue' : 'black';

              $('#YES_stck_prpr').text(stck_prpr); // 주식 가격 표시
              $('#YES_prdy_vrss').text(prdy_vrss).css('color', color); // 변동 표시

              $('#YES_total').text(stck_prpr); // 총 가격 업데이트

              var client = parseFloat($('#client_total').text().replace(/[^0-9.]/g, '')); // 클라이언트 총액
              if (client < stck_prpr) {
                  $('#YES_coinBtn').hide(); // 부족할 경우 버튼 숨기기
                  $('#YES_pointBtn').show(); // 포인트 버튼 표시
              } else {
                  $('#YES_coinBtn').show(); // 충분할 경우 코인 버튼 표시
                  $('#YES_pointBtn').hide(); // 포인트 버튼 숨기기
              }
          },
          error: function (jqXHR) {
              if (jqXHR.status == '401') {
                  alert('로그인 후 이용해주세요'); // 로그인 요구 알림
                  location.href = '/members/login'; // 로그인 페이지로 이동
              } else {
                  alert(jqXHR.responseText); // 기타 오류 알림
              }
          }
      });
  }

  function point() {
      location.href = "/charge"; // 충전 페이지로 이동
  }

  function KDR_coin() {
      var token = $("meta[name='_csrf']").attr("content"); // CSRF 토큰 가져오기
      var header = $("meta[name='_csrf_header']").attr("content"); // CSRF 헤더 가져오기

      var coinMoney = $('#KDR_total').text(); // KDR 총 가격
      var coin = $('#KDR_coin').val(); // 선택된 코인 개수

      var url = "/coin/add/KDR/" + coin + "/" + coinMoney; // KDR 코인 구매 요청 URL
      var paramData = {
          coinMoney: coinMoney,
          coin: coin
      };

      $.ajax({
          url: url,
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(paramData), // JSON 형식으로 데이터 전송
          beforeSend: function (xhr) {
              xhr.setRequestHeader(header, token); // CSRF 값 설정
          },
          dataType: "json",
          cache: false,
          success: function () {
              alert("코인 구매 완료!"); // 구매 완료 알림
              location.href = "/coinList"; // 코인 목록 페이지로 이동
          },
          error: function (jqXHR) {
              if (jqXHR.status == '401') {
                  alert('로그인 후 이용해주세요.'); // 로그인 요구 알림
                  location.href = '/members/login'; // 로그인 페이지로 이동
              } else {
                  alert(jqXHR.responseText); // 기타 오류 알림
              }
          }
      });
  }

  function YES_coin() {
      var token = $("meta[name='_csrf']").attr("content"); // CSRF 토큰 가져오기
      var header = $("meta[name='_csrf_header']").attr("content"); // CSRF 헤더 가져오기

      var coinMoney = $('#YES_total').text(); // YES 총 가격
      var coin = $('#YES_coin').val(); // 선택된 코인 개수

      var url = "/coin/add/YES/" + coin + "/" + coinMoney; // YES 코인 구매 요청 URL
      var paramData = {
          coinMoney: coinMoney,
          coin: coin
      };

      $.ajax({
          url: url,
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(paramData), // JSON 형식으로 데이터 전송
          beforeSend: function (xhr) {
              xhr.setRequestHeader(header, token); // CSRF 값 설정
          },
          dataType: "json",
          cache: false,
          success: function () {
              alert("코인 구매 완료!"); // 구매 완료 알림
              location.href = "/coinList"; // 코인 목록 페이지로 이동
          },
          error: function (jqXHR) {
              if (jqXHR.status == '401') {
                  alert('로그인 후 이용해주세요.'); // 로그인 요구 알림
                  location.href = '/members/login'; // 로그인 페이지로 이동
              } else {
                  alert(jqXHR.responseText); // 기타 오류 알림
              }
          }
      });
  }

  function sliding() {
      var context = document.getElementById('slide_context');
      // 'show' 클래스를 토글하여 슬라이드 효과 적용
      if (context.classList.contains('show')) {
          context.classList.remove('show');
      } else {
          context.classList.add('show');
      }
  }

    </script>
</th:block>

    <th:block layout:fragment="css">
    <style>
                /* 부모 컨테이너 */
         .container {
             max-width: 600px; /* 최대 너비 설정 */
             min-width: 300px; /* 최소 너비 설정 */
             margin: 0 auto; /* 중앙 정렬 */
              flex-direction: column;
             padding: 0 15px; /* 좌우 여백 설정 */
         }

         /* card */
         .card,  .gragh{
             width: 100%;
             max-width: 600px; /* 최대 너비 설정 */
             min-width: 300px; /* 최소 너비 설정 */
             margin: 20px auto;
             text-align: center;
         }

           .sel_1, .sel_2 {
             margin: 10px;

         }


         .sel_2, .sel_3 {
            text-align: right; /* 텍스트 오른쪽 정렬 */
            width: 350px; /* 너비 설정 */
            margin-left: auto; /* 왼쪽 여백 자동으로 설정 */
            margin-right: 0; /* 오른쪽 여백 0 설정 */
        }


         .fs-2 {
             font-size: 0.8em; /* 폰트 사이즈 조정 */
         }

         .btnBtn {
             margin-top: 10px;
         }



         /* 슬라이드 컨테이너 */
         #slide_context {
             width: 100%; /* 폭을 부모에 맞춤 */
             max-width: 600px; /* 최대 너비 설정 */
             min-width: 300px; /* 최소 너비 설정 */
             overflow: hidden; /* 내용이 넘치는 것을 숨김 */
             max-height: 0; /* 초기 최대 높이 설정 */
             opacity: 0; /* 초기 투명도 설정 */
             transition: max-height 0.5s ease-out, opacity 0.5s ease-out; /* 애니메이션 트랜지션 설정 */
             background-color: white; /* 배경 색상 설정 (선택 사항) */
             padding: 0; /* 여백 초기 설정 */
             border: 1px solid #dee2e6; /* 테두리 설정 (선택 사항) */
             border-radius: 4px; /* 테두리 둥글게 설정 (선택 사항) */
             margin: 20px auto; /* 카드와 동일한 여백 설정 */
         }

         /* show 클래스 */
         #slide_context.show {
             max-height: 500px; /* 슬라이드가 열릴 때의 최대 높이 설정 */
             opacity: 1; /* 보일 때 투명도 설정 */
             padding: 10px; /* 여백 설정 (선택 사항) */
         }
    </style>
    </th:block>



<div layout:fragment="content">
<h3>그래프</h3>
    <div class="sel_1">
        <select id="current">
            <option th:value="KDR">키다리스튜디오(020120)</option>
            <option th:value="YES">예스24(053280)</option>
        </select>
    </div>


    <div class="sel_2">

        현재 포인트: <span th:text="${total}"></span>point


    </div>
    <div class="sel_3">
        키다리 코인:
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-currency-euro" viewBox="0 0 16 16">
            <path d="M4 9.42h1.063C5.4 12.323 7.317 14 10.34 14c.622 0 1.167-.068 1.659-.185v-1.3c-.484.119-1.045.17-1.659.17-2.1 0-3.455-1.198-3.775-3.264h4.017v-.928H6.497v-.936q-.002-.165.008-.329h4.078v-.927H6.618c.388-1.898 1.719-2.985 3.723-2.985.614 0 1.175.05 1.659.177V2.194A6.6 6.6 0 0 0 10.341 2c-2.928 0-4.82 1.569-5.244 4.3H4v.928h1.01v1.265H4v.928z"/>
        </svg>
        <span id="KDRCoin"></span>
        예스 코인:
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-currency-yen" viewBox="0 0 16 16">
            <path d="M8.75 14v-2.629h2.446v-.967H8.75v-1.31h2.445v-.967H9.128L12.5 2h-1.699L8.047 7.327h-.086L5.207 2H3.5l3.363 6.127H4.778v.968H7.25v1.31H4.78v.966h2.47V14h1.502z"/>
        </svg>
        <span id="YESCoin"></span>
    </div>

    <div class="container">
    <div class="h4 pb-2 mb-4 text-danger border-bottom border-info"></div>
        <div class="card" id="KDR">
            <div class="card-header">
                <h2>키다리스튜디오(020120)</h2>
            </div>
            <div class="card-body">
                <div>
                    <span class="fs-1" id="KDR_stck_prpr"></span>원<!--주식의 현재 가격을 나타내는 변수나 속성 이름-->
                    <span class="fs-2" id="KDR_prdy_vrss"></span>
                              <!-- 주식 변동 가격을 여기에 표시 -->
                <div>
                    <span>변경 코인 수량</span>
                    <select id="KDR_coin">
                        <option value="1">1코인</option>
                        <option value="10">10코인</option>
                        <option value="25">25코인</option>
                        <option value="50">50코인</option>
                        <option value="100">100코인</option>
                    </select>

                </div>
                <div>
                    총<span id="KDR_total"></span>포인트
                </div>

            </div>
                <div class="btnBtn">
                    <button type="button" id="KDR_coinBtn"  class="btn btn-outline-secondary"
                            onclick="KDR_coin()">코인 결제</button>
                    <button type="button" id="KDR_pointBtn"  class="btn btn-outline-secondary"
                            onclick='point()'>포인트 결제</button>

                </div>

        </div>
    </div>
    <div class="gragh">
        <canvas id="myChartKDR" style="width:100%;max-width:700px"></canvas>
        <script>
            // 그래프 설정
          var now = new Date();

          // 7일 전 날짜 계산
          var minusWeek = new Date(now);
          minusWeek.setDate(now.getDate() -6);
          //6일 전(일주일)으로 변경
          // 날짜 배열 초기화
          var xValues = [];
          // 7일 간의 날짜 배열 생성
          for (var date = new Date(minusWeek); date <= now; date.setDate(date.getDate() + 1)) {
              var formattedDate = date.toISOString().slice(0,10); // "YYYY-MM-DD" 형식
              xValues.push(formattedDate); //배열에 추가
          }


          // 서버에서 데이터를 받아오는 반복문
            var yValues1_1=  [ [[${KDR}]] ];
            var yValues1=yValues1_1.pop(0);

          new Chart(document.getElementById("myChartKDR"), {
              type: "line",
              data: {
                  labels: xValues,
                  datasets: [{
                      data: yValues1,
                      borderColor: "red",
                      fill: false
                  }]
              },
              options: {
                  legend: { display: false }
              }
          });

        </script>
    </div>

        <div class="card" id="YES">
            <div class="card-header">
                <h2>예스24(053280)</h2>
            </div>
            <div class="card-body">
                <div>
                    <span class="fs-1" id="YES_stck_prpr"></span>원<!--주식의 현재 가격을 나타내는 변수나 속성 이름-->
                    <span class="fs-2" id="YES_prdy_vrss" ></span>
                </div>
                <div>
                    <span>변경 코인 수량</span>
                    <select id="YES_coin">
                        <option value="1">1코인</option>
                        <option value="10">10코인</option>
                        <option value="25">25코인</option>
                        <option value="50">50코인</option>
                        <option value="100">100코인</option>
                    </select>

                </div>
                <div>
                    총<span id="YES_total"></span>포인트
                </div>
                <div class="btnBtn">
                    <button type="button" id="YES_coinBtn"  class="btn btn-outline-secondary"
                            onclick="coin()">코인 결제</button>
                    <button type="button" id="YES_pointBtn"  class="btn btn-outline-secondary"
                            onclick='point()'>포인트 결제</button>

                </div>
            </div>

        </div>
    <div class="gragh">
        <div>
            <canvas id="myChartYES" style="width:100%;max-width:700px"></canvas>
            <script>
                // 그래프 설정
              var now = new Date();

              // 7일 전 날짜 계산
              var minusWeek = new Date(now);
              minusWeek.setDate(now.getDate() -6);
              //6일 전(일주일)으로 변경
              // 날짜 배열 초기화
              var xValues = [];
              // 7일 간의 날짜 배열 생성
              for (var date = new Date(minusWeek); date <= now; date.setDate(date.getDate() + 1)) {
                  var formattedDate = date.toISOString().slice(0,10); // "YYYY-MM-DD" 형식
                  xValues.push(formattedDate); //배열에 추가
              }


              // 서버에서 데이터를 받아오는 반복문
                var yValues1_1=  [ [[${YES}]] ];
                var yValues1=yValues1_1.pop(0);

              new Chart(document.getElementById("myChartYES"), {
                  type: "line",
                  data: {
                      labels: xValues,
                      datasets: [{
                          data: yValues1,
                          borderColor: "red",
                          fill: false
                      }]
                  },
                  options: {
                      legend: { display: false }
                  }
              });

            </script>
        </div>

        <div onclick="sliding()">
            <span>결제 내역</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
            </svg>
        </div>
        <div id="slide_context" >
            <table>
                <thead>
                <tr>
                    <th style="width:180px;">내용</th>
                    <th style="width:180px;">포인트</th>
                    <th style="width:100px;">키다리 코인</th>
                    <th style="width:100px;">예스 코인</th>

                </tr>
                </thead>
                <tbody th:each="ch : ${coinList}">
                <tr>
                    <td th:text="${ch.point.content}" ></td>
                    <td th:text="${ch.point.point}" ></td>
                    <td th:text="${ch.KDR_coin}"></td>
                    <td th:text="${ch.YES_coin}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>


    </div>






</div>
</html>